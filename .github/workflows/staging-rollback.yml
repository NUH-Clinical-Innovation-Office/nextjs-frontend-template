name: Staging Rollback

on:
  workflow_dispatch:
    inputs:
      revision:
        description: "Helm revision number to rollback to (leave empty for previous revision)"
        required: false
        type: string

env:
  NODE_VERSION: "24.12.0"

jobs:
  rollback:
    name: Rollback Staging
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: staging
      url: https://${{ github.event.repository.name }}-staging.${{ vars.CLOUDFLARE_DOMAIN }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.KUBECONFIG_STAGING }}" ]; then
            MISSING_SECRETS+=("KUBECONFIG_STAGING")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "✗ ERROR: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            echo ""
            echo "Please configure these secrets in your repository settings."
            exit 1
          fi

          echo "✓ All required secrets are configured"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.13.0"

      - name: Setup Kubernetes config
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_STAGING }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Validate release exists and can be rolled back
        run: |
          NAMESPACE="${{ github.event.repository.name }}-staging"
          RELEASE_NAME="nextjs-app"

          # Check if release exists
          if ! helm list -n "$NAMESPACE" | grep -q "$RELEASE_NAME"; then
            echo "✗ ERROR: No Helm release found for $RELEASE_NAME in namespace $NAMESPACE"
            echo "Cannot rollback a release that doesn't exist."
            exit 1
          fi

          # Get current revision
          CURRENT_REVISION=$(helm list -n "$NAMESPACE" -o json | jq -r '.[] | select(.name=="'$RELEASE_NAME'") | .revision')

          echo "Current revision: $CURRENT_REVISION"

          # Check if there's a previous revision to rollback to
          if [ "$CURRENT_REVISION" -eq 1 ] && [ -z "${{ inputs.revision }}" ]; then
            echo "✗ ERROR: Cannot rollback - currently at revision 1 (first deployment)"
            echo "There is no previous revision to rollback to."
            exit 1
          fi

          # If specific revision is provided, validate it exists and is not the current one
          if [ -n "${{ inputs.revision }}" ]; then
            TARGET_REVISION="${{ inputs.revision }}"

            if [ "$TARGET_REVISION" -eq "$CURRENT_REVISION" ]; then
              echo "✗ ERROR: Target revision $TARGET_REVISION is the same as current revision"
              echo "Cannot rollback to the same revision."
              exit 1
            fi

            if [ "$TARGET_REVISION" -gt "$CURRENT_REVISION" ]; then
              echo "✗ ERROR: Target revision $TARGET_REVISION is higher than current revision $CURRENT_REVISION"
              echo "Cannot rollback to a future revision."
              exit 1
            fi

            # Check if target revision exists in history
            if ! helm history "$RELEASE_NAME" -n "$NAMESPACE" -o json | jq -e '.[] | select(.revision=='$TARGET_REVISION')' >/dev/null; then
              echo "✗ ERROR: Revision $TARGET_REVISION not found in deployment history"
              echo "Available revisions:"
              helm history "$RELEASE_NAME" -n "$NAMESPACE"
              exit 1
            fi
          fi

          echo "✓ Rollback validation passed"

      - name: Show deployment history
        run: |
          echo "Current deployment history:"
          helm history nextjs-app -n ${{ github.event.repository.name }}-staging --max 10

      - name: Rollback Helm release
        run: |
          NAMESPACE="${{ github.event.repository.name }}-staging"
          RELEASE_NAME="nextjs-app"

          if [ -n "${{ inputs.revision }}" ]; then
            echo "Rolling back to revision ${{ inputs.revision }}"
            helm rollback "$RELEASE_NAME" ${{ inputs.revision }} -n "$NAMESPACE" --wait --timeout 10m
          else
            echo "Rolling back to previous revision"
            helm rollback "$RELEASE_NAME" -n "$NAMESPACE" --wait --timeout 10m
          fi

      - name: Verify rollback
        run: |
          kubectl rollout status deployment/nextjs-app -n ${{ github.event.repository.name }}-staging --timeout=1m

          echo ""
          echo "Rollback completed successfully!"
          echo "Current revision:"
          helm list -n ${{ github.event.repository.name }}-staging
