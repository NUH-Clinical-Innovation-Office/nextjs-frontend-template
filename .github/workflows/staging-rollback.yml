name: Staging Rollback

on:
  workflow_dispatch:

env:
  NODE_VERSION: "24.12.0"

jobs:
  rollback:
    name: Rollback Staging
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: staging
      url: https://${{ github.event.repository.name }}-staging.${{ vars.CLOUDFLARE_DOMAIN }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate last deployment was successful
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking if there's a successful staging deployment..."

          # Get the last deployment to the staging environment
          LAST_DEPLOY=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/deployments?environment=staging&per_page=1" \
            --jq '.[0]')

          if [ -z "$LAST_DEPLOY" ] || [ "$LAST_DEPLOY" = "null" ]; then
            echo "✗ ERROR: No deployment found for staging environment"
            echo "Cannot rollback when there are no deployments."
            exit 1
          fi

          DEPLOYMENT_ID=$(echo "$LAST_DEPLOY" | jq -r '.id')

          # Get the deployment status
          DEPLOY_STATUS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses" \
            --jq '.[0].state')

          if [ "$DEPLOY_STATUS" != "success" ]; then
            echo "✗ ERROR: Last staging deployment status: $DEPLOY_STATUS"
            echo "Cannot rollback when the last deployment was not successful."
            exit 1
          fi

          echo "✓ Found successful staging deployment (ID: $DEPLOYMENT_ID)"

      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.KUBECONFIG_STAGING }}" ]; then
            MISSING_SECRETS+=("KUBECONFIG_STAGING")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "✗ ERROR: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            echo ""
            echo "Please configure these secrets in your repository settings."
            exit 1
          fi

          echo "✓ All required secrets are configured"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.13.0"

      - name: Setup Kubernetes config
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_STAGING }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Validate release exists and can be rolled back
        run: |
          NAMESPACE="${{ github.event.repository.name }}-staging"
          RELEASE_NAME="nextjs-app"

          # Check if release exists
          if ! helm list -n "$NAMESPACE" | grep -q "$RELEASE_NAME"; then
            echo "✗ ERROR: No Helm release found for $RELEASE_NAME in namespace $NAMESPACE"
            echo "Cannot rollback a release that doesn't exist."
            exit 1
          fi

          # Get current revision
          CURRENT_REVISION=$(helm list -n "$NAMESPACE" -o json | jq -r '.[] | select(.name=="'$RELEASE_NAME'") | .revision')

          echo "Current revision: $CURRENT_REVISION"

          # Check if there's a previous revision to rollback to
          if [ "$CURRENT_REVISION" -eq 1 ]; then
            echo "✗ ERROR: Cannot rollback - currently at revision 1 (first deployment)"
            echo "There is no previous revision to rollback to."
            exit 1
          fi

          echo "✓ Rollback validation passed - will rollback from revision $CURRENT_REVISION to revision $((CURRENT_REVISION - 1))"

      - name: Show deployment history
        run: |
          echo "Current deployment history:"
          helm history nextjs-app -n ${{ github.event.repository.name }}-staging --max 10

      - name: Rollback Helm release
        run: |
          NAMESPACE="${{ github.event.repository.name }}-staging"
          RELEASE_NAME="nextjs-app"

          echo "Rolling back to previous revision"
          helm rollback "$RELEASE_NAME" -n "$NAMESPACE" --wait --timeout 10m

      - name: Verify rollback
        run: |
          kubectl rollout status deployment/nextjs-app -n ${{ github.event.repository.name }}-staging --timeout=1m

          echo ""
          echo "Rollback completed successfully!"
          echo "Current revision:"
          helm list -n ${{ github.event.repository.name }}-staging
